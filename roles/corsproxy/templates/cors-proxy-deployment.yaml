---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cors-proxy
  namespace: "{{ ansible_operator_meta.namespace }}"
  labels:
    app: cors-proxy
    part-of: 3scale-saas
spec:
{% if hpa.enabled is defined and hpa.enabled == false %}
  replicas: {{ replicas }}
{% endif %}
  selector:
    matchLabels:
      deployment: cors-proxy
  strategy:
    rollingUpdate:
      # Never go below desired, increase the
      # max number of pods instead
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: cors-proxy
        part-of: 3scale-saas
        deployment: cors-proxy
    spec:
{% if image.pull_secret_name is defined %}
      imagePullSecrets:
        - name: "{{ image.pull_secret_name | default(image_pull_secret_name) }}"
{% endif %}
      containers:
        - name: cors-proxy
          image: "{{ image.name | default(image_name) }}:{{ image.tag | default(image_tag) }}"
          ports:
            - containerPort: 8080
              name: http
            - containerPort: 9145
              name: metrics
          livenessProbe:
            httpGet:
              path: /healthz
              port: 9145
              scheme: HTTP
            initialDelaySeconds: {{ liveness_probe.initial_delay_seconds | default(liveness_probe_initial_delay_seconds) }}
            timeoutSeconds: {{ liveness_probe.timeout_seconds | default(liveness_probe_timeout_seconds) }}
            periodSeconds: {{ liveness_probe.period_seconds | default (liveness_probe_period_seconds) }}
            successThreshold: {{ liveness_probe.success_threshold | default(liveness_probe_success_threshold) }}
            failureThreshold: {{ liveness_probe.failure_threshold | default(liveness_probe_failure_threshold) }}
          readinessProbe:
            httpGet:
              path: /healthz
              port: 9145
              scheme: HTTP
            initialDelaySeconds: {{ readiness_probe.initial_delay_seconds | default(readiness_probe_initial_delay_seconds) }}
            timeoutSeconds: {{ readiness_probe.timeout_seconds | default(readiness_probe_timeout_seconds) }}
            periodSeconds: {{ readiness_probe.period_seconds | default(readiness_probe_period_seconds) }}
            successThreshold: {{ readiness_probe.success_threshold | default(readiness_probe_success_threshold) }}
            failureThreshold: {{ readiness_probe.failure_threshold | default(readiness_probe_failure_threshold) }}
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: cors-proxy-system-database
                  key: DSN
          resources:
            requests:
              memory: "{{ resources.requests.memory | default(resources_requests_memory) }}"
              cpu: "{{ resources.requests.cpu | default(resources_requests_cpu) }}"
            limits:
              memory: "{{ resources.limits.memory | default(resources_limits_memory) }}"
              cpu: "{{ resources.limits.cpu | default(resources_limits_cpu) }}"
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              topologyKey: kubernetes.io/hostname
              labelSelector:
                matchLabels:
                  deployment: cors-proxy
          - weight: 99
            podAffinityTerm:
              topologyKey: failure-domain.beta.kubernetes.io/zone
              labelSelector:
                matchLabels:
                  deployment: cors-proxy


